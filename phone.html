<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Socket.io</title>
        <style>
            video {
                position: fixed;
                right: 0;
                bottom: 0;
                width: 100%;
            }
        </style>
    </head>

    <body>

        <video id="video" controls>
            <source src="countdown.mp4" type="video/mp4">
            Sorry, your browser doesn't support embedded videos.
        </video>

        <ul id="messageList"></ul>

        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            //var socket = io.connect('http://localhost:8080');
            //var socket = io.connect('http://192.168.43.202:8080');
            var socket = io.connect('http://172.20.10.2:8080');

            var videos = {
                '1' : 'countdown.mp4',
                '2' : 'crabe_rav.mp4'
            };
            var videoName = {
                '1' : 'Countdown',
                '2' : 'Crab Rav'
            };

            // We ask for the id of the client
            var id = prompt('Identifiant :');
            // We send it to the server
            socket.emit('identifiant', id);

            var video = document.getElementById("video");
            video.src = videos[id];
            socket.emit('choosedVideo', id, videoName[id]);

            // Play he video for the specified time
            socket.on('playVideo', function(playTime) {
                //var video = document.getElementById("video");
                // We hide the control panel of the video
                video.controls = false;
                playTime = parseInt(playTime);
                var startTime = video.currentTime;
                //console.log('startTime : ' + startTime);
                var endTime = startTime + playTime;
                //console.log('endTime : ' + endTime);
                playVideo(video, startTime, endTime);
            });

            function playVideo(video, startTime, playTime) {
                function checkTime() {
                    if (video.currentTime >= playTime) {
                       video.pause();
                    // We check if the video has reach the end
                    } else if (video.currentTime == video.duration) {
                        video.currentTime = 0;
                    } else {
                       // call checkTime every tenth of a second
                       setTimeout(checkTime, 100);
                    }
                }
                // We check if the video has reach the end
                if (video.currentTime != video.duration) {
                    video.currentTime = startTime;
                    video.play();
                    checkTime();
                // if so, we set it back to 0 to start the video over
                } else {
                    video.currentTime = 0;
                }
            }

            // We add the message to the list when receiving one
            socket.on('messageFrom', function(id, message) {
                console.log('message received');
                var li = document.createElement('li');
                li.innerHTML = '<li>Server said : ' + message + '</li>';
                document.getElementById("messageList").appendChild(li);
            });
        </script>
    </body>
</html>
